<html>

<head>

	<!-- Load ioBroker scripts and styles-->
	<link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
	<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

	<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="../../socket.io/socket.io.js"></script>

	<script type="text/javascript" src="../../js/translate.js"></script>
	<script type="text/javascript" src="../../lib/js/materialize.js"></script>
	<script type="text/javascript" src="../../js/adapter-settings.js"></script>

	<!-- Load our own files -->
	<link rel="stylesheet" type="text/css" href="style.css" />
	<script type="text/javascript" src="words.js"></script>

	<script type="text/javascript">
		// This will be called by the admin adapter when the settings page loads
		function load(settings, onChange) {
			// example: select elements with id=key and class=value and insert value
			if (!settings) return;

			showGeneralSetupDialog();

			$('.value').each(function () {
				var $key = $(this);
				var id = $key.attr('id');
				if ($key.attr('type') === 'checkbox') {
					// do not call onChange direct, because onChange could expect some arguments
					$key.prop('checked', settings[id])
						.on('change', () => onChange())
						;
				} else {
					// do not call onChange direct, because onChange could expect some arguments
					$key.val(settings[id])
						.on('change', () => onChange())
						.on('keyup', () => onChange())
						;
				}

                //add sanity checks
				$key.val(settings[id]).focusout("change", function () {
                    if (id === "synoUrl") {
                        var ip1 = $("#synoUrl").val();
                        if (isUrlValid(ip1)) {
                            $("#synoUrl").val(ip1);
                        } else {
                            alert("Please enter a valid URL to your Synology Chat application\nwith prefix (http/s://) and without postfix (/)\n\n Valide sample values:\n - https://mychat.mydomain.com\n - https://192.168.x.x:8080");
                            //restore
                            $("#synoUrl").val(settings.synoUrl).change();
                        }
                    }

                });
			});

            getExtendableInstances(function (result) {
                if (result) {
                    var text = '';
                    for (var r = 0; r < result.length; r++) {
                        var name = result[r]._id.substring('system.adapter.'.length);
                        text += '<option value="' + name + '">' + name + '</option>';
                    }
                    $('#webInstance').append(text).val(settings.webInstance).select();
                    showHideSettings();
                }
            });

			onChange(false);
			// reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
			if (M) M.updateTextFields();
		}

		// This will be called by the admin adapter when the user presses the save button
		function save(callback) {
			// example: select elements with class=value and build settings object
			var obj = {};
			$('.value').each(function () {
				var $this = $(this);
				if ($this.attr('type') === 'checkbox') {
					obj[$this.attr('id')] = $this.prop('checked');
				} else if ($this.attr('type') === 'number') {
					obj[$this.attr('id')] = parseFloat($this.val());
				} else {
					obj[$this.attr('id')] = $this.val();
				}
			});
			callback(obj);
		}

		function isUrlValid(inputText) {
			var format = /^(http:\/\/|https:\/\/)[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?|^(http:\/\/|https:\/\/)(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(?::\d{0,4})?$/;
            return !!inputText.match(format);
        }

		function disableAllDialogs() {
            $(".c-tab").removeClass("tab-active");
            var x = document.getElementsByClassName("dialog");
            for (var cnt = 0; cnt < x.length; cnt++) {
                x[cnt].style.display = "none";
            }
        }

		function showGeneralSetupDialog() {
            disableAllDialogs();
            $(".dialog-general-setup").addClass("tab-active");
            var x = document.getElementById("generalSetupDialog");
            x.style.display = "block";
        }
		
        function showChannelConfigDialog() {
            disableAllDialogs();
            $('.dialog-channel-config').addClass('tab-active');
            var x = document.getElementById("channelConfigDialog");
            x.style.display = "block";
        }

		function showHelpDialog() {
            disableAllDialogs();
            $('.dialog-help').addClass('tab-active');
            var x = document.getElementById("helpDialog");
            x.style.display = "block";
        }
	</script>

</head>

<body>

	<div class="m adapter-container">
		<nav>
            <div class="row">
                <div class="col s5">
                    <img src="synochat.png" class="logo" style="float: left">
                    <font size="+2"><big>Synology-Chat</big></font>
                </div>
            </div>
        </nav>
        <div class="row">
            <ul class="tabs">
                <li class="tab col s3 dialog-general-setup c-tab translate"><a onclick="showGeneralSetupDialog()">General setup</a></li>
                <li class="tab col s3 dialog-channel-config c-tab translate"><a onclick="showChannelConfigDialog()">Channel configuration</a></li>
				<!-- <li class="tab col s3 dialog-help c-tab translate"><a onclick="showHelpDialog()">Help</a></li> -->
				<li class="tab col s3 c-tab translate"><a target="_blank" class="translate" href="https://github.com/phoeluga/ioBroker.synochat">Help</a></li>
			
            </ul>
        </div>
		<div id="generalSetupDialog" class="dialog">
            <div class="card">
                <div class="card-content">
                    <div class="row">
                        <div class="input-field col s6 l2">
                            <input class="value" id="synoUrl" type="text" />
                            <label for="synoUrl" class="translate">Synology URL/IP</label>
                        </div>
                        <div class="input-field col s6 l2">
                            <input class="value" id="certCheck" type="checkbox" />
                            <label class="translate" for="certCheck">Validate SSL certificate</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 l3 input-field">
                            <select class="value" id="webInstance">
								<option value="*" class="translate">Any</option>
								<!-- <option value="outgoing">Outgoing</option> -->
							</select>
                            <label class="translate" for="webInstance">Web instance for messages send from Synology chat to ioBroker adapter instance</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		<div id="channelConfigDialog" class="dialog">
            <div class="card">
                <div class="card-content">
                    <div class="row">
                        <div class="col s12">
                            <h6>
								<span class="translate">
									<strong>NOTE:</strong>
                                    <br>
                                    <em>The channel type must be specified from the perspective of the Synology chat. For example, selecting 'Incoming' in the configuration means that the messages will be sent to the Synology chat.</em>
								</span>
							</h6>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-content">
                    <div class="row">
						<div class="input-field col s6 l2">
                            <input class="value" id="channelName" type="text" />
                            <label class="translate" for="channelName">Channel name</label>
                        </div>
                        <div class="input-field col s12 l4">
                            <input class="value" id="channelToken" type="text" />
                            <label class="translate" for="channelToken">Channel token</label>
                        </div>
                        <div class="col s12 l3 input-field">
                            <select class="value" id="channelType">
								<option value="incoming">Get data from Synology chat server</option>
								<option value="outgoing">Send data to Synology chat server</option>
							</select>
                            <label class="translate" for="channelType">Channel type</label>
                        </div>
                        <div class="input-field col s6 l2">
                            <input class="value" id="channelContentCertCheck" type="checkbox" />
                            <label class="translate" for="channelContentCertCheck">Validate SSL certificate for non-text messages</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		<div id="helpDialog" class="dialog">
            <div class="card">
                <div class="card-content">
                    <div class="row">
                        <div class="col s12">
                            <h6>
								<span class="translate">
									Adapter help goes here...
								</span>
							</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
	</div>
</body>

</html>
